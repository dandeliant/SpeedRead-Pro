<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SpeedRead Pro — Nowoczesny Trener Szybkiego Czytania</title>

  <!-- PWA meta -->
  <meta name="theme-color" content="#0b1020" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" sizes="192x192" href="icon-192.png">
  <link rel="icon" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="apple-touch-icon-180.png">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Opcjonalna czcionka przyjazna dyslektykom -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <style>
    :root {
      --primary: #3b82f6;
      --primary-600:#2563eb;
      --accent: #f97316;
      --ok: #10b981;
      --warn:#f59e0b;
      --danger:#ef4444;
      --bg: #0b1020;
      --panel: #111831;
      --panel-2:#0e152b;
      --text: #e5ecff;
      --muted:#94a3b8;
      --ring: rgba(59,130,246,.35);
      --shadow: 0 10px 25px rgba(2,8,23,.35);
      --radius: 16px;
    }
    /* Jasny motyw */
    .light {
      --bg:#f8fafc; --panel:#ffffff; --panel-2:#f1f5f9; --text:#0f172a; --muted:#475569;
      --shadow: 0 10px 25px rgba(2,8,23,.08);
    }

    *, *::before, *::after { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0; font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 10% -10%, #1e293b 0%, transparent 60%),
                  radial-gradient(1200px 600px at 110% 10%, #0f172a 0%, transparent 60%),
                  var(--bg);
      color: var(--text);
      display:flex; flex-direction:column; align-items:center;
    }

    header {
      width:100%; position:sticky; top:0; z-index:20;
      backdrop-filter: saturate(140%) blur(10px);
      background: linear-gradient(180deg, rgba(15,23,42,.8) 0%, rgba(15,23,42,.4) 100%);
      border-bottom: 1px solid rgba(148,163,184,.15);
    }
    .wrap { width:min(1100px, 92vw); margin-inline:auto; }
    .topbar { display:flex; align-items:center; gap:12px; padding:14px 0; }
    .brand { display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px; }
    .brand .logo { width:38px; height:38px; display:grid; place-items:center; border-radius:12px; background:linear-gradient(135deg, var(--primary), var(--accent)); box-shadow: var(--shadow); }
    .brand span { font-size: clamp(18px, 2vw, 22px) }
    .top-actions { margin-left:auto; display:flex; gap:8px; align-items:center; }

    .btn { appearance:none; border:none; border-radius:10px; padding:10px 14px; color:white; background:var(--primary); cursor:pointer; display:inline-flex; align-items:center; gap:8px; font-weight:600; transition:.2s transform, .2s background; box-shadow: 0 6px 16px rgba(59,130,246,.25); }
    .btn:hover { transform: translateY(-1px); background:var(--primary-600) }
    .btn.secondary { background:transparent; color:var(--text); border:1px solid rgba(148,163,184,.25); box-shadow:none }
    .btn.secondary:hover { background: rgba(148,163,184,.08) }
    .btn.ghost { background:transparent; color:var(--text); padding:10px; border-radius:12px }
    .btn.ghost:hover { background: rgba(148,163,184,.1) }
    .icon { width:1.1em; text-align:center }

    main { width:100%; }
    .grid { display:grid; gap:18px; grid-template-columns: 1fr; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1.2fr .8fr } }

    .card { background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%); border:1px solid rgba(148,163,184,.12); border-radius:var(--radius); box-shadow: var(--shadow); overflow:hidden }
    .card h3 { margin:0; font-size:1rem; letter-spacing:.3px }
    .card .head { display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid rgba(148,163,184,.12) }
    .card .body { padding:18px }

    /* Pole tekstu */
    textarea { width:100%; min-height:160px; resize:vertical; border-radius:12px; border:1px solid rgba(148,163,184,.25); background:rgba(2,6,23,.25); color:var(--text); padding:14px; font-size:16px; line-height:1.5; outline:none; box-shadow: inset 0 0 0 1px transparent; transition: box-shadow .2s, border-color .2s }
    textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--ring) }

    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center }
    .row > * { flex: none }

    /* Wyświetlacz RSVP */
    .display { position:relative; height:140px; border-radius:16px; background: radial-gradient(100% 100% at 50% 0%, rgba(59,130,246,.15) 0%, transparent 70%), rgba(2,6,23,.35); border:1px solid rgba(148,163,184,.2); display:grid; place-items:center; font-size: clamp(26px, 4.8vw, 40px); text-align:center; padding:18px; user-select:none; }
    .display .focus-mask { position:absolute; inset:0; pointer-events:none; mask: radial-gradient(160px 85px at 50% 55%, rgba(0,0,0,0) 60%, rgba(0,0,0,1) 61%); background: rgba(0,0,0,.4); opacity:0; transition:.25s }
    .display.focused .focus-mask { opacity:1 }
    .eye-guide { position:absolute; left:50%; top:10%; transform:translateX(-50%); width:2px; height:80%; background:linear-gradient(180deg, transparent, rgba(250,250,255,.45), transparent); opacity:.6; pointer-events:none }

    .progress { width:100%; height:10px; border-radius:999px; background:rgba(148,163,184,.18); overflow:hidden }
    .progress > span { display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--primary), var(--accent)); transition: width .2s }

    .stat-cards { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px }
    .stat { background: rgba(2,6,23,.35); border:1px solid rgba(148,163,184,.15); border-radius:12px; padding:12px; text-align:center }
    .stat .k { font-size:20px; font-weight:800 }
    .muted { color: var(--muted) }

    .ranges { display:grid; gap:10px; grid-template-columns: 1fr 1fr }
    .range { background: rgba(2,6,23,.35); border:1px solid rgba(148,163,184,.15); border-radius:12px; padding:10px }
    .range label { display:flex; justify-content:space-between; align-items:center; gap:6px; font-size:14px; margin-bottom:6px }
    input[type="range"]{ width:100% }

    .switch { display:inline-flex; gap:8px; align-items:center; cursor:pointer; user-select:none }
    .switch input{ appearance:none; width:46px; height:26px; background:#334155; border-radius:999px; position:relative; outline:none; transition:.2s }
    .switch input::after{ content:""; position:absolute; top:3px; left:3px; width:20px; height:20px; background:white; border-radius:50%; transition:.2s }
    .switch input:checked{ background: var(--primary) }
    .switch input:checked::after{ left:23px }

    .kbd { border:1px solid rgba(148,163,184,.35); border-bottom-width:2px; padding:2px 6px; border-radius:8px; font-weight:700; font-size:12px }

    footer { margin: 24px 0 32px; color: var(--muted) }

    /* Achievements pop */
    .toast { position:fixed; right:18px; bottom:18px; background:linear-gradient(180deg, #0b1324, #0a1222); border:1px solid rgba(148,163,184,.22); color:var(--text); padding:12px 14px; border-radius:12px; box-shadow: var(--shadow); display:flex; gap:10px; align-items:center; opacity:0; transform: translateY(10px); pointer-events:none; transition:.25s }
    .toast.show { opacity:1; transform: translateY(0); pointer-events:auto }

    .hidden { display:none }

    /* Modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(15,23,42,.6); display:grid; place-items:center; z-index:50; opacity:0; pointer-events:none; transition:.2s }
    .modal-backdrop.show { opacity:1; pointer-events:auto }
    .modal { width:min(560px, 92vw); background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%); border:1px solid rgba(148,163,184,.15); border-radius:16px; box-shadow: var(--shadow); overflow:hidden }
    .modal .head { padding:14px 16px; border-bottom:1px solid rgba(148,163,184,.12); display:flex; align-items:center; justify-content:space-between }
    .modal .body { padding:16px }

    .pill { display:inline-flex; align-items:center; gap:6px; border:1px solid rgba(148,163,184,.25); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted) }

    .o-dyslexic { font-family: 'OpenDyslexic', 'Atkinson Hyperlegible', system-ui, sans-serif }
    @font-face { font-family: 'OpenDyslexic'; font-style: normal; font-weight: 400;
      src: url('https://cdn.jsdelivr.net/gh/antijingoist/open-dyslexic/compiled/OpenDyslexic-Regular.woff2') format('woff2'); font-display: swap; }
  </style>
</head>
<body>
  <header>
    <div class="wrap topbar">
      <div class="brand">
        <div class="logo"><i class="fa-solid fa-bolt"></i></div>
        <span>SpeedRead Pro</span>
      </div>
      <div class="top-actions">
        <button id="btn-toggle-theme" class="btn ghost" title="Przełącz motyw (Jasny/Ciemny)"><i class="fa-solid fa-circle-half-stroke"></i></button>
        <button id="btn-help" class="btn secondary"><i class="fa-regular fa-circle-question"></i> Pomoc</button>
      </div>
    </div>
  </header>

  <main class="wrap" id="app">
    <div class="grid">
      <!-- LEWA kolumna: wejście, sterowanie -->
      <section class="card">
        <div class="head">
          <h3>Wybierz/Zredaguj tekst</h3>
          <div class="row">
            <button id="btn-sample" class="btn secondary"><i class="fa-solid fa-book-open"></i> Przykład</button>
            <button id="btn-save" class="btn secondary" title="Zapisz do przeglądarki"><i class="fa-regular fa-floppy-disk"></i> Zapisz</button>
            <button id="btn-load" class="btn secondary" title="Wczytaj zapisane"><i class="fa-regular fa-folder-open"></i> Wczytaj</button>
          </div>
        </div>
        <div class="body">
          <textarea id="text" placeholder="Wklej lub wpisz materiał do czytania…"></textarea>

          <div class="row" style="margin-top:10px">
            <button id="btn-file" class="btn secondary"><i class="fa-solid fa-file-import"></i> Z pliku .txt</button>
            <input id="file" type="file" accept=".txt" class="hidden" />
            <button id="btn-url" class="btn secondary" title="Uwaga: wiele stron blokuje pobieranie bezpośrednie (CORS)"><i class="fa-solid fa-link"></i> Z adresu URL</button>
          </div>
        </div>
      </section>

      <!-- PRAWA kolumna: ustawienia -->
      <aside class="card">
        <div class="head">
          <h3>Ustawienia czytania</h3>
          <span class="pill"><i class="fa-regular fa-keyboard"></i> Spacja — start/stop</span>
        </div>
        <div class="body">
          <div class="ranges">
            <div class="range">
              <label>Prędkość (sł./min) <strong id="wpm-val">300</strong></label>
              <input id="wpm" type="range" min="50" max="1200" value="300" />
              <div class="row" style="margin-top:6px">
                <button class="btn secondary preset" data-wpm="150">Wolno 150</button>
                <button class="btn secondary preset" data-wpm="300">Standard 300</button>
                <button class="btn secondary preset" data-wpm="500">Szybko 500</button>
                <button class="btn secondary preset" data-wpm="800">Pro 800</button>
              </div>
            </div>
            <div class="range">
              <label>Porcja słów <strong id="chunk-val">1</strong></label>
              <input id="chunk" type="range" min="1" max="5" value="1" />
              <div class="row" style="margin-top:6px">
                <button class="btn secondary chunk" data-chunk="1">1</button>
                <button class="btn secondary chunk" data-chunk="2">2</button>
                <button class="btn secondary chunk" data-chunk="3">3</button>
              </div>
            </div>
            <div class="range">
              <label>Rozmiar czcionki <strong id="fs-val">2.0rem</strong></label>
              <input id="fs" type="range" min="1" max="4" step=".1" value="2" />
            </div>
            <div class="range">
              <label>Kontrast tła <strong id="bg-val">35%</strong></label>
              <input id="bgc" type="range" min="0" max="80" value="35" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <label class="switch"><input id="focus" type="checkbox"><span>Tryb ostrości</span></label>
            <label class="switch"><input id="guide" type="checkbox" checked><span>Linia wzroku</span></label>
            <label class="switch"><input id="dyslexic" type="checkbox"><span>Font dyslektyczny</span></label>
          </div>

          <div class="row" style="margin-top:10px; align-items: end">
            <label class="switch"><input id="tts" type="checkbox"><span>Czytaj na głos (TTS)</span></label>
            <select id="voice" class="btn secondary" style="min-width:220px">
              <option value="">Wybierz głos…</option>
            </select>
          </div>

          <div class="row" style="margin-top:12px">
            <button id="btn-play" class="btn"><i class="fa-solid fa-play"></i> Czytaj</button>
            <button id="btn-reset" class="btn secondary"><i class="fa-solid fa-rotate-right"></i> Reset</button>
            <button id="btn-sprint" class="btn" style="background:var(--ok)"><i class="fa-solid fa-stopwatch"></i> Sprint 60s</button>
          </div>
        </div>
      </aside>
    </div>

    <!-- Wyświetlacz + pasek postępu + statystyki -->
    <section class="card" style="margin-top:18px">
      <div class="body">
        <div id="display" class="display">
          <div class="eye-guide" id="eye" ></div>
          <div class="focus-mask" id="mask"></div>
          <div id="words">Twój tekst pojawi się tutaj</div>
        </div>

        <div style="margin-top:12px" class="row">
          <div class="progress" style="flex:1"><span id="bar"></span></div>
          <span class="pill"><i class="fa-regular fa-clock"></i> <span id="eta">--:--</span></span>
          <span class="pill"><i class="fa-solid fa-gauge"></i> <span id="aspeed">0 sł./min</span></span>
          <span class="pill"><i class="fa-regular fa-square-check"></i> <span id="count">0 / 0 (0%)</span></span>
        </div>
      </div>
    </section>

    <!-- Dzienny bilans -->
    <section class="card" style="margin-top:8px">
      <div class="head"><h3>Statystyki dzienne</h3><button id="btn-clear-stats" class="btn secondary"><i class="fa-regular fa-trash-can"></i></button></div>
      <div class="body stat-cards">
        <div class="stat"><div class="muted">Sesje</div><div id="s-sessions" class="k">0</div></div>
        <div class="stat"><div class="muted">Słowa dziś</div><div id="s-words" class="k">0</div></div>
        <div class="stat"><div class="muted">Łącznie (min)</div><div id="s-min" class="k">0.0</div></div>
      </div>
    </section>
  </main>

  <footer>
    © 2025 Daniel Ostrowski — SpeedRead Pro · <span class="muted">Skróty: <span class="kbd">Spacja</span> start/stop, <span class="kbd">Ctrl</span> + <span class="kbd">↑/↓</span> tempo, <span class="kbd">N</span>/<span class="kbd">B</span> następny/poprzedni blok</span>
  </footer>

  <!-- Toast -->
  <div id="toast" class="toast"><i class="fa-solid fa-trophy" style="color:gold"></i><span id="toast-txt">Gratulacje!</span></div>

  <!-- MODALE -->
  <div id="modal-load" class="modal-backdrop">
    <div class="modal">
      <div class="head"><strong>Twoje zapisane teksty</strong><button class="btn ghost" data-close="modal-load"><i class="fa-solid fa-xmark"></i></button></div>
      <div class="body" id="saved-list">Brak zapisów.</div>
    </div>
  </div>

  <div id="modal-url" class="modal-backdrop">
    <div class="modal">
      <div class="head"><strong>Import z adresu URL</strong><button class="btn ghost" data-close="modal-url"><i class="fa-solid fa-xmark"></i></button></div>
      <div class="body">
        <p class="muted" style="margin-top:0">Wiele serwisów blokuje bezpośredni odczyt (CORS). Możesz wkleić artykuł ręcznie lub użyć własnego proxy.</p>
        <div class="row"><input id="url" class="btn secondary" placeholder="https://…" style="flex:1" />
          <button id="import-url" class="btn"><i class="fa-solid fa-cloud-arrow-down"></i> Importuj</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-help" class="modal-backdrop">
    <div class="modal">
      <div class="head"><strong>Pomoc i skróty</strong><button class="btn ghost" data-close="modal-help"><i class="fa-solid fa-xmark"></i></button></div>
      <div class="body">
        <ul>
          <li><span class="kbd">Spacja</span> — Start/Stop</li>
          <li><span class="kbd">Ctrl</span> + <span class="kbd">↑/↓</span> — Zmiana prędkości o 50</li>
          <li><span class="kbd">N</span>/<span class="kbd">B</span> — Następny/Poprzedni blok</li>
          <li><span class="kbd">R</span> — Reset sesji</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    const state = {
      words: [], index: 0, chunk: 1, wpm: 300,
      playing: false, t0: 0, acc: 0, timer: null,
      fontSize: 2, bgContrast: 35,
      stats: { day: new Date().toDateString(), sessions: 0, words: 0, minutes: 0 },
      tts: { enabled:false, utter:new SpeechSynthesisUtterance(), voice:null },
      sprint: null
    };

    // UI refs
    const el = {
      text: $('#text'),
      display: $('#display'), words: $('#words'), bar: $('#bar'), eta: $('#eta'), aspeed: $('#aspeed'), count: $('#count'), eye: $('#eye'), mask: $('#mask'),
      wpm: $('#wpm'), wpmv: $('#wpm-val'), chunk: $('#chunk'), chunkv: $('#chunk-val'), fs: $('#fs'), fsv: $('#fs-val'), bgc: $('#bgc'), bgv: $('#bg-val'),
      focus: $('#focus'), guide: $('#guide'), dys: $('#dyslexic'),
      btnPlay: $('#btn-play'), btnReset: $('#btn-reset'), btnSample: $('#btn-sample'),
      btnSave: $('#btn-save'), btnLoad: $('#btn-load'), savedList: $('#saved-list'),
      btnFile: $('#btn-file'), file: $('#file'),
      btnUrl: $('#btn-url'), url: $('#url'), importUrl: $('#import-url'),
      btnSprint: $('#btn-sprint'),
      // stats
      sSessions: $('#s-sessions'), sWords: $('#s-words'), sMin: $('#s-min'),
      // tts
      tts: $('#tts'), voice: $('#voice'),
      // theme/help
      toggleTheme: $('#btn-toggle-theme'), help: $('#btn-help'),
      // modals
      mLoad: $('#modal-load'), mUrl: $('#modal-url'), mHelp: $('#modal-help'),
      toast: $('#toast'), toastTxt: $('#toast-txt')
    };

    // THEME
    const themeKey = 'sr-theme';
    function applyTheme(name){
      if(name==='light') document.body.classList.add('light');
      else document.body.classList.remove('light');
      localStorage.setItem(themeKey, name);
      // spójny pasek przeglądarki na Androidzie
      const metaTheme = document.querySelector('meta[name="theme-color"]');
      metaTheme && (metaTheme.setAttribute('content', getComputedStyle(document.body).getPropertyValue('--bg').trim()));
    }
    applyTheme(localStorage.getItem(themeKey)||'dark');
    el.toggleTheme.addEventListener('click', ()=>{
      const next = document.body.classList.contains('light') ? 'dark' : 'light';
      applyTheme(next);
    });

    // HELP
    function openModal(node){ node.classList.add('show'); }
    function closeModal(node){ node.classList.remove('show'); }
    $$('[data-close]').forEach(b=> b.addEventListener('click', e=> closeModal($('#'+b.dataset.close))));
    el.help.addEventListener('click', ()=> openModal(el.mHelp));

    // TEXT
    const sample = `Szybkie czytanie to umiejętność, którą może rozwinąć każdy. Polega na zwiększeniu prędkości przyswajania informacji przy utrzymaniu zrozumienia. Regularny trening pozwala ograniczyć subwokalizację, skrócić czas fiksacji wzroku i poszerzyć pole widzenia. Testuj różne prędkości i porcje słów, by znaleźć optymalny rytm.`;
    el.btnSample.addEventListener('click', ()=>{ el.text.value = sample; resetSession(); });

    // FILE
    el.btnFile.addEventListener('click', ()=> el.file.click());
    el.file.addEventListener('change', e=>{
      const f = e.target.files[0]; if(!f) return;
      const rd = new FileReader(); rd.onload = ev=> { el.text.value = ev.target.result; resetSession(); }; rd.readAsText(f);
    });

    // URL (proste, może wymagać własnego proxy)
    el.btnUrl.addEventListener('click', ()=> openModal(el.mUrl));
    el.importUrl.addEventListener('click', async ()=>{
      const url = (el.url.value||'').trim(); if(!url) return;
      try{
        const res = await fetch(url, {mode:'no-cors'});
        toast('Z uwagi na zabezpieczenia CORS wklej tekst ręcznie lub użyj własnego proxy.');
      }catch(err){ toast('Nie można pobrać treści: '+ err.message) }
      closeModal(el.mUrl);
    });

    // SAVE/LOAD
    const keyTexts = 'sr-texts';
    el.btnSave.addEventListener('click', ()=>{
      const v = el.text.value.trim(); if(!v) return toast('Brak treści do zapisania.');
      const all = JSON.parse(localStorage.getItem(keyTexts)||'[]');
      all.push({ id: Date.now(), title: 'Tekst '+ new Date().toLocaleString(), text: v });
      localStorage.setItem(keyTexts, JSON.stringify(all));
      toast('Zapisano.');
    });
    el.btnLoad.addEventListener('click', ()=>{
      const all = JSON.parse(localStorage.getItem(keyTexts)||'[]');
      el.savedList.innerHTML = all.length? '' : 'Brak zapisów.';
      all.forEach(it=>{
        const row = document.createElement('div'); row.className='row'; row.style.justifyContent='space-between'; row.style.margin='8px 0';
        row.innerHTML = `<div><strong>${it.title}</strong><div class="muted" style="font-size:12px">${new Date(it.id).toLocaleString()}</div></div>
        <div class="row"><button class="btn secondary" data-id="${it.id}"><i class="fa-regular fa-folder-open"></i></button>
        <button class="btn secondary" data-del="${it.id}"><i class="fa-regular fa-trash-can"></i></button></div>`;
        el.savedList.appendChild(row);
      });
      openModal(el.mLoad);
      el.savedList.onclick = (e)=>{
        const id = e.target.closest('button')?.dataset?.id;
        const del = e.target.closest('button')?.dataset?.del;
        if(id){ const t = JSON.parse(localStorage.getItem(keyTexts)||'[]').find(x=>x.id==id); if(t){ el.text.value=t.text; resetSession(); closeModal(el.mLoad); }}
        if(del){ const rest = JSON.parse(localStorage.getItem(keyTexts)||'[]').filter(x=>x.id!=del); localStorage.setItem(keyTexts, JSON.stringify(rest)); e.target.closest('.row').remove(); }
      }
    });

    // SETTINGS bindings
    function bindRange(input, label, on){ input.addEventListener('input', ()=>{ label.textContent = input.id==='fs' ? input.value+'rem' : input.id==='bgc' ? input.value+'%' : input.value; on(Number(input.value)); }); }
    bindRange(el.wpm, el.wpmv, v=>{ state.wpm=v; if(state.playing) restart(); });
    bindRange(el.chunk, el.chunkv, v=>{ state.chunk=v; if(state.playing) restart(); });
    bindRange(el.fs, el.fsv, v=>{ state.fontSize=v; el.display.style.fontSize = v+'rem'; });
    bindRange(el.bgc, el.bgv, v=>{ state.bgContrast=v; el.display.style.background = `radial-gradient(100% 100% at 50% 0%, rgba(59,130,246,${v/300}) 0%, transparent 70%), rgba(2,6,23,${.2 + v/200})`; });

    el.focus.addEventListener('change', ()=> el.display.classList.toggle('focused', el.focus.checked));
    el.guide.addEventListener('change', ()=> el.eye.style.display = el.guide.checked? 'block':'none');
    el.dys.addEventListener('change', ()=> document.body.classList.toggle('o-dyslexic', el.dys.checked));

    $$('.preset').forEach(b=> b.addEventListener('click', ()=>{ el.wpm.value=b.dataset.wpm; el.wpm.dispatchEvent(new Event('input')); }));
    $$('.chunk').forEach(b=> b.addEventListener('click', ()=>{ el.chunk.value=b.dataset.chunk; el.chunk.dispatchEvent(new Event('input')); }));

    // CORE reading logic
    function tokenize(txt){ return txt.trim().split(/\s+/).filter(Boolean); }
    function calcDelay(){ const msPerWord = 60000 / state.wpm; return msPerWord; }

    function showWords(){
      if(state.index >= state.words.length){ return finish(); }
      const slice = state.words.slice(state.index, state.index + state.chunk);
      // Bionic-style: środkowa litera podświetlona
      const html = slice.map(w=>{
        const m = Math.max(0, Math.floor(w.length/2));
        return el.focus.checked ? `${w.slice(0,m)}<span style="color:var(--accent);font-weight:800">${w[m]||''}</span>${w.slice(m+1)}` : w;
      }).join(' ');
      el.words.innerHTML = html;
      const p = (state.index / state.words.length) * 100; el.bar.style.width = p.toFixed(2)+'%';
      el.count.textContent = `${Math.min(state.index, state.words.length)} / ${state.words.length} (${p.toFixed(1)}%)`;
      // ETA & actual speed
      const elapsedMin = (performance.now() - state.t0 + state.acc) / 60000;
      const ar = Math.max(1, state.index); const as = Math.round(ar / Math.max(.001, elapsedMin));
      el.aspeed.textContent = `${as} sł./min`;
      const remain = (state.words.length - state.index) / Math.max(1, state.wpm);
      const m = Math.floor(remain); const s = Math.round((remain - m) * 60); el.eta.textContent = `${String(m).padStart(1,'0')}:${String(s).padStart(2,'0')}`;

      // TTS
      if(state.tts.enabled && state.tts.voice){ speak(slice.join(' ')); }
    }

    function step(){ state.index += state.chunk; showWords(); if(state.index >= state.words.length) return; schedule(); }
    function schedule(){ clearTimeout(state.timer); state.timer = setTimeout(step, calcDelay()); }

    function start(){
      if(state.playing) return; const raw = el.text.value; if(!raw.trim()) return toast('Wklej najpierw tekst.');
      if(state.index===0){ state.words = tokenize(raw); bumpStats('sessions',1); saveStats(); }
      state.playing = true; state.t0 = performance.now(); showWords(); schedule();
      el.btnPlay.innerHTML = '<i class="fa-solid fa-pause"></i> Pauza';
    }
    function pause(){ if(!state.playing) return; state.playing=false; clearTimeout(state.timer); state.acc += performance.now()-state.t0; el.btnPlay.innerHTML = '<i class="fa-solid fa-play"></i> Kontynuuj'; saveStatsLive(); }
    function restart(){ if(state.playing){ clearTimeout(state.timer); schedule(); } }
    function finish(){ pause(); state.index = state.words.length; showWords(); el.bar.style.width='100%'; el.eta.textContent='Przeczytane!';
      const spentMin = (state.acc)/60000; bumpStats('minutes', spentMin); bumpStats('words', state.words.length); saveStats();
      toast('Sesja zakończona. Świetna robota!');
    }
    function resetSession(){ pause(); state.index = 0; state.acc = 0; state.words = []; el.words.textContent='Gotowe do startu'; el.bar.style.width='0%'; el.count.textContent='0 / 0 (0%)'; el.eta.textContent='--:--'; el.aspeed.textContent='0 sł./min'; el.btnPlay.innerHTML = '<i class="fa-solid fa-play"></i> Czytaj'; }

    el.btnPlay.addEventListener('click', ()=> state.playing? pause(): start());
    el.btnReset.addEventListener('click', resetSession);

    // Sprint 60s
    el.btnSprint.addEventListener('click', ()=>{
      if(state.sprint){ clearTimeout(state.sprint); state.sprint=null; }
      resetSession(); start();
      toast('Sprint 60 sekund — powodzenia!');
      state.sprint = setTimeout(()=>{ pause(); toast(`Sprint: ${state.index} słów w 60s`); }, 60000);
    });

    // KEYBOARD
    document.addEventListener('keydown', (e)=>{
      if(e.key===' '){ e.preventDefault(); state.playing? pause(): start(); }
      if((e.key==='ArrowUp'||e.key==='ArrowDown') && e.ctrlKey){ e.preventDefault(); const d = e.key==='ArrowUp'? 50 : -50; el.wpm.value = Math.min(1200, Math.max(50, Number(el.wpm.value)+d)); el.wpm.dispatchEvent(new Event('input')); }
      if(e.key==='n' || e.key==='N'){ e.preventDefault(); state.index = Math.min(state.words.length, state.index + state.chunk); showWords(); }
      if(e.key==='b' || e.key==='B'){ e.preventDefault(); state.index = Math.max(0, state.index - state.chunk); showWords(); }
      if(e.key==='r' || e.key==='R'){ resetSession(); }
    });

    // STATS
    const kStats = 'sr-stats-v1';
    function loadStats(){ const s = JSON.parse(localStorage.getItem(kStats)||'{}'); if(s.day!==new Date().toDateString()){ state.stats = { day:new Date().toDateString(), sessions:0, words:0, minutes:0 }; } else { state.stats = s; } renderStats(); }
    function saveStats(){ localStorage.setItem(kStats, JSON.stringify(state.stats)); renderStats(); }
    function saveStatsLive(){ const spentMin = (state.acc)/60000; state.stats.minutes += spentMin; state.stats.words += state.index; state.acc=0; saveStats(); }
    function bumpStats(k, v){ state.stats[k] += v; renderStats(); }
    function renderStats(){ el.sSessions.textContent = state.stats.sessions; el.sWords.textContent = state.stats.words; el.sMin.textContent = state.stats.minutes.toFixed(1); }
    $('#btn-clear-stats').addEventListener('click', ()=>{ if(confirm('Wyzerować dzisiejsze statystyki?')){ state.stats = { day:new Date().toDateString(), sessions:0, words:0, minutes:0 }; saveStats(); }});

    // TTS
    function listVoices(){
      const voices = speechSynthesis.getVoices();
      el.voice.innerHTML = '<option value="">Wybierz głos…</option>' + voices
        .map(v=>`<option value="${v.name}">${v.name} — ${v.lang}</option>`).join('');
      const pref = voices.find(v=>/^en-GB/i.test(v.lang)) || voices.find(v=>/^pl-PL/i.test(v.lang)) || voices[0];
      if(pref){ el.voice.value = pref.name; state.tts.voice = pref; }
    }
    speechSynthesis.onvoiceschanged = listVoices; listVoices();

    el.tts.addEventListener('change', ()=>{ state.tts.enabled = el.tts.checked; if(!state.tts.enabled) speechSynthesis.cancel(); });
    el.voice.addEventListener('change', ()=>{ const v = speechSynthesis.getVoices().find(x=>x.name===el.voice.value); state.tts.voice = v || null; });

    function speak(text){ try{ const u = state.tts.utter; u.text = text; u.rate = Math.min(2.5, Math.max(.5, state.wpm/300)); u.pitch = 1; u.voice = state.tts.voice; speechSynthesis.cancel(); speechSynthesis.speak(u); }catch(e){} }

    // TOAST
    let toastTimer = null;
    function toast(msg){ clearTimeout(toastTimer); el.toastTxt.textContent = msg; el.toast.classList.add('show'); toastTimer = setTimeout(()=> el.toast.classList.remove('show'), 2800); }

    // INIT
    function init(){ loadStats(); el.display.style.fontSize = state.fontSize+'rem'; el.display.classList.toggle('focused', el.focus.checked); }
    init();

    // === PWA: rejestracja Service Workera (obsługa subfolderu na GitHub Pages) ===
    (function registerSW(){
      if (!('serviceWorker' in navigator)) return;
      // Jeśli aplikacja jest hostowana pod /nazwa-repo/ , SW też musi być pod tym prefiksem
      const repoMatch = location.pathname.match(/^\/([^/]+)\/?/); // zwraca /repo w project pages
      const base = (location.hostname.endsWith('github.io') && repoMatch) ? `/${repoMatch[1]}/` : '/';
      navigator.serviceWorker.register(`${base}sw.js`).catch(console.error);
    })();
  </script>
</body>
</html>
